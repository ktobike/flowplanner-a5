<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowPlanner — Export</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,1,0" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="phone">

    <!-- HEADER -->
    <header class="header">
      <span class="material-symbols-rounded" onclick="history.back()" style="cursor:pointer">arrow_back</span>
      <div>
        <div class="app">Export Plan</div>
        <div class="sub">Sync to calendar or share</div>
      </div>
    </header>

    <!-- MAIN -->
    <section class="main">
      <div class="card">
        <div class="row">
          <!-- Button now has id for script -->
          <a class="btn" id="icsBtn"><span class="material-symbols-rounded">event_available</span>Add to Calendar</a>
          <a class="btn secondary"><span class="material-symbols-rounded">share</span>Share with partner</a>
        </div>

        <div class="card" style="margin-top:14px">
          <div style="font-weight:600; margin-bottom:6px">Preview</div>
          <div class="small">Tue 7–9p · STAT PSet start</div>
          <div class="small">Wed 7–10p · CIS PSet continue</div>
          <div class="small">Fri 5p · HIST Draft due</div>
        </div>

        <div class="row" style="margin-top:16px">
          <a class="btn secondary" href="index.html"><span class="material-symbols-rounded">home</span>Back to Home</a>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
      <span class="small">Step 4 of 4 · Export</span>
      <span class="small">Done</span>
    </footer>
  </main>

  <!-- ✅ SCRIPT: ICS Export Implementation -->
  <script>
    // Utility to format datetime in ICS spec
    function pad(n){ return String(n).padStart(2,'0'); }
    function dt(d){
      const x = new Date(d);
      const y = x.getFullYear(), m = pad(x.getMonth()+1), da = pad(x.getDate());
      return `${y}${m}${da}T090000Z`; // 9am UTC placeholder
    }

    // Demo events from your preview
    const events = [
      { summary: "STAT PSet start", date: "2025-11-18" },
      { summary: "CIS PSet continue", date: "2025-11-19" },
      { summary: "HIST Draft due", date: "2025-11-21" }
    ];

    // Build ICS calendar text
    function buildICS(name, items){
      let s = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//FlowPlanner//EN\nCALSCALE:GREGORIAN\n";
      s += `X-WR-CALNAME:${name}\n`;
      items.forEach(it=>{
        const uid = Math.random().toString(36).slice(2);
        s += "BEGIN:VEVENT\n";
        s += `UID:${uid}@flowplanner\n`;
        s += `DTSTAMP:${dt(it.date)}\n`;
        s += `DTSTART:${dt(it.date)}\n`;
        s += `SUMMARY:${it.summary}\n`;
        s += "DURATION:PT60M\n";
        s += "END:VEVENT\n";
      });
      s += "END:VCALENDAR\n";
      return s;
    }

    // Trigger browser download
    function download(filename, text){
      const blob = new Blob([text], {type:"text/calendar;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Bind button
    document.getElementById("icsBtn").onclick = ()=>{
      const ics = buildICS("FlowPlanner Plan", events);
      download("flowplanner.ics", ics);
      alert("Your FlowPlanner events have been exported as a calendar file (.ics).");
    };
  </script>
</body>
</html>
